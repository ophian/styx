tinymce.PluginManager.add('magicline',(editor,url)=>{const WHITE_SPACE='\u00A0';const TRIANGLE_HTML='<span class="tox-magicline-triangle"></span>';let magicLineTop,magicLineBottom;let triggerOffset,holdDistance,boxColor,rtl,tabuList,triggers;let hideTimeout;let currentTarget=null;let newTarget=null;let realParentTarget=null;let hoverDelay=50;let hoverIntent=null;const createMagicLine=(className)=>{const line=editor.dom.create('div',{'class':`tox-magicline ${className}`,'contenteditable':'false','data-mce-bogus':'all',style:`position:absolute;height:5px;${boxColor ? `background-color:${boxColor};` : ''};display:none;cursor:pointer;z-index:1600;`},TRIANGLE_HTML);editor.getBody().appendChild(line);return line};const showMagicLines=(target)=>{clearTimeout(hideTimeout);currentTarget=target;const bodyRect=editor.getBody().getBoundingClientRect();const rect=target.getBoundingClientRect();const commonStyles={top:'auto',right:'0',bottom:'auto',left:'7px',display:'block'};editor.dom.setStyles(magicLineTop,{...commonStyles,top:`${rect.top + 5}px`,display:canInsertAbove(target)?'block':'none'});editor.dom.setStyles(magicLineBottom,{...commonStyles,bottom:`${bodyRect.top - 5}px`,display:canInsertBelow(target)?'block':'none'})};const checkMagicLines=()=>{if(!editor.getBody().lastChild.classList.contains('tox-magicline')){magicLineTop.remove();magicLineBottom.remove();clearTimeout(hideTimeout);clearTimeout(hoverIntent);magicLineTop=createMagicLine('tox-magicline-top');magicLineBottom=createMagicLine('tox-magicline-bottom')}};const hideMagicLines=()=>{clearTimeout(hideTimeout);hideTimeout=setTimeout(()=>{editor.dom.setStyles(magicLineTop,{display:'none'});editor.dom.setStyles(magicLineBottom,{display:'none'});currentTarget=null},2400)};const isLastElement=(element)=>{const hasElement=element.nodeName.toLowerCase()==='pre'||element.nodeName.toLowerCase()==='table';if(typeof element.nextElementSibling==="undefined")return!1;return hasElement};const isStyxImg=(element)=>{const hasImage=element.querySelector('.serendipity_image_left, .serendipity_image_right, .serendipity_image_center, .serendipity_imageComment_left, .serendipity_imageComment_right, .serendipity_imageComment_center')!==null;return hasImage};const canInsertAbove=(target)=>{if(target&&target.className==='serendipity_imageComment_img'){newTarget=target.parentNode.closest('div');target=newTarget?newTarget:target.parentNode.closest('figure')}
prevSibling=target.previousElementSibling;return!prevSibling||prevSibling.nodeName.toLowerCase()!=='p'};const canInsertBelow=(target)=>{if(target&&target.className==='serendipity_imageComment_img'){newTarget=target.parentNode.closest('div');target=newTarget?newTarget:target.parentNode.closest('figure')}
nextSibling=target.nextElementSibling;return!nextSibling||nextSibling.nodeName.toLowerCase()!=='p'};const insertParagraph=(target,isTop)=>{try{const newParagraph=editor.dom.create('p',{},'<br data-mce-bogus="1">');if(isTop){if(target.previousElementSibling){target.parentNode.insertBefore(newParagraph,target)}else{if(target.className==='serendipity_imageComment_img'){newTarget=target.parentNode.closest('div');target=newTarget?newTarget:target.parentNode.closest('figure');target.parentNode.insertBefore(newParagraph,target)}else{editor.getBody().insertBefore(newParagraph,editor.getBody().firstChild)}}}else{if(target!==null&&target.parentNode&&target.parentNode.nodeName.toLowerCase()==='figure'&&target.parentNode.className==='serendipity_imageComment_center'){realParentTarget=target.parentNode.closest('div');if(realParentTarget===null){target=target.closest('figure')}}
target=realParentTarget?realParentTarget:target;if(target!==null&&target.parentNode){target.parentNode.insertBefore(newParagraph,target.nextElementSibling)}}
editor.selection.select(newParagraph,!0);editor.selection.collapse(!0)}catch(error){}};const initPlugin=()=>{const config=editor.getParam('magicline',{});triggerOffset=config.triggerOffset||30;holdDistance=Math.floor(triggerOffset*(config.holdDistance||0.5));boxColor='';rtl=editor.getParam('directionality')==='rtl';tabuList=['data-mce-bogus'].concat(config.tabuList||[]);triggers='table,pre';magicLineTop=createMagicLine('tox-magicline-top');magicLineBottom=createMagicLine('tox-magicline-bottom');editor.on('mousemove',(e)=>{clearTimeout(hoverIntent);hoverIntent=setTimeout(()=>{const target=e.target.closest('div:not(.tox-magicline)')||e.target.closest('p>a.serendipity_image_link')||e.target.closest('p:has(img.serendipity_image_center, img.serendipity_image_left, img.serendipity_image_right)')||e.target.closest('pre[class*="language-"]')||e.target.closest('table');if(target&&(isStyxImg(target)||isLastElement(target))){if(target!==currentTarget){checkMagicLines();showMagicLines(target)}}else{hideMagicLines()}},hoverDelay)});editor.on('mouseout',(e)=>{if(!e.relatedTarget||!e.relatedTarget.closest('.tox-magicline')){clearTimeout(hoverIntent);hideMagicLines()}});editor.on('click',(e)=>{if(e.target.classList.contains('tox-magicline')&&currentTarget){const isTop=e.target.classList.contains('tox-magicline-top');insertParagraph(currentTarget,isTop);hideMagicLines();e.preventDefault()}})};editor.on('init',initPlugin);editor.on('load',hideMagicLines);editor.on('remove',()=>{if(magicLineTop)magicLineTop.remove();if(magicLineBottom)magicLineBottom.remove();clearTimeout(hideTimeout);clearTimeout(hoverIntent)});return{getMetadata:()=>{return{name:'Magic Line',url:url}}}})