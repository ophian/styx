/**
 * TinyMCE MagicLine Plugin:
 * Adds a red "insert paragraph" line between block elements, with robust handling for images, galleries, floats, and touch devices.
 * Features smart overlays, accessibility, and device-specific hints.
 * Copyright Ian Styx for The Serendipity Styx blog Edition, last modified 2025-06-30, 01:56, v. 2.1.0
 */
!function(){function e(...e){const t=window.MAGICLINE_DEBUG_FILTER;if(!(window.MAGICLINE_DEBUG||!!t&&t.length>0))return;if(t){const n=e[0];if("string"!=typeof n||!n.startsWith(t))return}const n=new Error;let i="";if(n.stack){const e=n.stack.split("\n");if(e.length>=3){const t=e[2].trim();let n=t.match(/:(\d+:\d+)\)?$/);i=n?"[ "+n[1]+" ]":t}}console.log("[MagicLine]",...e,i)}const t="ontouchstart"in window,n=["DIV","FIGURE","H1","H2","SECTION","ARTICLE","ASIDE","NAV"],i=[],o={en:{insertParagraph:"Insert paragraph",touchTip:"Tap the red line to insert a new paragraph here!",tapAgain:"Tap again to insert a new paragraph here.",before:"before",after:"after",hint:' ... [ Hint: Some red line added elements are irreversible via the ↩ "undo" toolbar button! Particularly between picture containers. Use normal keyboard context delete or reset via source view. ]',tip:"Tip: Click or press Enter to insert a new paragraph here."},de:{insertParagraph:"Absatz einfügen",touchTip:"Tippen Sie auf die rote Linie, um hier einen neuen Absatz einzufügen!",tapAgain:"Tippen Sie erneut, um hier einen neuen Absatz einzufügen.",before:"vor",after:"nach",hint:' ... [ Hinweis: Manche Absätze über die rote Linie sind nicht über den ↩ "undo" Toolbar Button rückgängig zu machen! Inbesondere zwischen Bildcontainern. Löschen Sie diese über die Tastatur oder im Quellcode. ]',tip:"Tipp: Klicken oder Enter drücken, um hier einen neuen Absatz einzufügen."}};tinymce.PluginManager.add("magicline",function(l){function a(){const e=l&&l.settings&&l.settings.magicline_lang||l&&l.settings&&l.settings.language||"undefined"!=typeof navigator&&navigator.language||"en";return o[e.slice(0,2)]||o.en}function r(){const e=a(),t=l&&l.settings&&l.settings.magicline?l.settings.magicline:{};let n="undefined"!=typeof window&&"undefined"!=typeof STYX_DARKMODE&&!0===STYX_DARKMODE;return{color:t.color||"#e53935",pointerColor:n?"#cdd9e5":"#1e2127",linger:t.linger||2500,fadeDuration:t.fadeDuration||350,attentionPulse:t.attentionPulse||900,firstTimeTip:t.firstTimeTip||`${e.tip}${e.hint}`}}let s,c,d,u,p,g,f,h,m,b,y=null,E=null,T=null,L=null,v=!1,x={};function w(e,t){return"before"===e?`<svg width="14" height="8"><polygon points="7,0 0,8 14,8" style="fill:${t};"/></svg>`:`<svg width="14" height="8"><polygon points="7,8 0,0 14,0" style="fill:${t};"/></svg>`}function C(e,t){let n=e;for(;n&&n!==t;){if(n.parentElement===t)return n;n=n.parentElement}return null}function k(e){let n=!1,i=null;t&&(e.addEventListener("touchstart",e=>{n=!0}),e.addEventListener("touchend",e=>{n=!1,i=null,clearTimeout(T),T=setTimeout(D,4e3)}),e.addEventListener("touchmove",t=>{if(!n)return;const o=t.touches[0],l=C(document.elementFromPoint(o.clientX,o.clientY),e);l&&l!==i?(i=l,I(),function(e){if(localStorage.getItem("magicLineHintShown"))return;const t=a(),n=document.createElement("div");n.textContent=`${t.touchTip}`,n.className="magicline-tooltip",n.style.position="absolute",n.style.background="#333",n.style.color="#fff",n.style.padding="6px 12px",n.style.borderRadius="6px",n.style.fontSize="14px",n.style.zIndex=9998;const i=e.getBoundingClientRect();n.style.top=window.scrollY+i.top-36+"px",n.style.left=window.scrollX+i.left+24+"px",document.body.appendChild(n),setTimeout(()=>{n.remove()},2600),localStorage.setItem("magicLineHintShown","1")}(l)):l||(D(),i=null)}))}function M(e){return e&&"P"===e.nodeName}function N(e){return!!M(e)&&e.textContent.replace(/\u00A0/g,"").trim().length>0}function A(e){if(!e||"P"!==e.nodeName)return!1;let t=e.textContent.replace(/[\u00A0\s\u200B-\u200D\uFEFF]/g,""),n=e.innerHTML.replace(/<br.*?>/gi,"").replace(/&nbsp;/gi,"").replace(/[\s\u200B-\u200D\uFEFF]/g,"").trim();return""===t&&""===n}function S(e){return e&&1===e.nodeType&&("DIV"===e.nodeName||"FIGURE"===e.nodeName||"SECTION"===e.nodeName||"ARTICLE"===e.nodeName||"ASIDE"===e.nodeName||"NAV"===e.nodeName)}function H(e){return e&&/^H[1-6]$/.test(e.nodeName)}function B(n,i){if(!n)return!1;if(t){e("[GET] data-magicline-position:",i,"on",n.outerHTML),e("[GET] magicLineUsedMap",x);const t=u._blockRef;if("before"===i?b=t.previousElementSibling||t:"after"===i&&(b=t.nextElementSibling||t),e("[GET] block",t,"realBlock",b),b){e("[GET] realBlock",b);let t=b.getAttribute("data-magicline-id");if(t&&x[t+"-"+i]||b.hasAttribute("data-magicline-"+i))return e("[GET] BLOCK: gap already used by ID, suppress MagicLine",t,i),!1}if(!b)return _=!1,v=!1,!1;if(A(b))return!1;if((o=b)&&"DIV"===o.nodeName&&(e("[GET] [isHitArea] node-el",o),"magic-line-hit-area"===o.className&&"none"!==o.style.display))return _=!1,v=!1,!1}var o;if(e("[GET] CHECK data-magicline-position:",i,"on",n.outerHTML),e("[GET] shouldShowMagicLine for block:",n,"position:",i,"data-before:",n.getAttribute("data-magicline-before"),"data-after:",n.getAttribute("data-magicline-after")),"used"===n.getAttribute("data-magicline-"+i))return e("[GET] BLOCK: gap already used, suppress MagicLine",n,i),!1;const l=n.previousElementSibling,a=n.nextElementSibling;if(e("[GET] [SML] shouldShowMagicLine:",{block:n,position:i,prev:l?{nodeName:l.nodeName,html:l.innerHTML,text:l.textContent}:null,next:a?{nodeName:a.nodeName,html:a.innerHTML,text:a.textContent}:null}),n.parentNode){const t=Array.from(n.parentNode.children),o=t.indexOf(n);if("before"===i&&o>0){const n=t[o-1];if("P"===n.nodeName&&A(n))return e("[GET] BLOCK: found empty <p> before block, suppress MagicLine",n),!1}if("after"===i&&o<t.length-1){const n=t[o+1];if("P"===n.nodeName&&A(n))return e("[GET] BLOCK: found empty <p> after block, suppress MagicLine",n),!1}}if(e("[GET] shouldShowMagicLine: checking",n,"position:",i,"prev:",l,"next:",a),"before"===i&&l&&M(l)&&A(l))return e("[GET] BLOCK: found empty <p> before block, suppress MagicLine"),!1;if("after"===i&&a&&M(a)&&A(a))return e("[GET] BLOCK: found empty <p> after block, suppress MagicLine"),!1;if(t){if("before"===i&&l&&A(l))return!1;if("after"===i&&a&&A(a))return!1}if("before"===i&&l&&A(l))return e("[POS] shouldShowMagicLine: prevent before, empty <p> exists"),!1;if("after"===i&&a&&A(a))return e("[POS] shouldShowMagicLine: prevent after, empty <p> exists"),!1;if("before"===i&&!l)return!M(n);if("before"===i&&l&&"PRE"===l.nodeName||"after"===i&&a&&"PRE"===a.nodeName)return!0;if(S(n)&&"before"===i){if(M(l))return N(l);if(S(l)||H(l))return!0}if(S(n)&&"after"===i){if(M(a))return N(a);if(S(a)||H(a)||!a)return!0}return S(n)&&(S(l)||H(l))&&"before"===i?(!l||l.nextElementSibling!==n||!A(l))&&(D(),!0):(M(n),!1)}let R=null,_=!1,G=!1;function I(){clearTimeout(m),clearTimeout(E),clearTimeout(T),u.style.opacity=1,u.style.display="block",e("[SML] Tooltip text:",g.textContent,g.style.display),g.style.display="block",h&&(h.style.display="block",h.style.pointerEvents="all"),e("[SML] Show MagicLine",u._blockRef),E=setTimeout(()=>{u.style.opacity=0,T=setTimeout(()=>{if(u.style.display="none",g.style.display="none",h&&(h.style.display="none"),h&&(h.style.pointerEvents="none"),u._lastHighlight){let e=u._lastHighlight;e.classList.add("magic-line-fading"),setTimeout(()=>{e.classList.remove("magic-line-highlight","magic-line-fading")},300),u._lastHighlight=null}_=!1,R=null},r().fadeDuration)},r().linger)}function D(){clearTimeout(E),clearTimeout(T),u.style.opacity=0,g.style.display="none",_=!1,R=null,v=!1,h&&(h.style.display="none"),h&&(h.style.pointerEvents="none"),setTimeout(()=>{if(u.style.display="none",g.style.display="none",h&&(h.style.display="none"),h&&(h.style.pointerEvents="none"),u._lastHighlight){let e=u._lastHighlight;e.classList.add("magic-line-fading"),setTimeout(()=>{e.classList.remove("magic-line-highlight","magic-line-fading")},300),u._lastHighlight=null}_=!1,R=null,v=!1},r().fadeDuration)}function P(){const t=a();u=document.createElement("div"),u.className="magic-line",u.setAttribute("tabindex","0"),u.setAttribute("role","button"),u.setAttribute("aria-label",`Insert paragraph${t.hint}`),u.style.cssText="position:absolute; top:0; left:0; height:60px; background:transparent; display:none; opacity:0; transition:opacity 0.35s cubic-bezier(0.4,0,0.2,1), box-shadow 0.2s; border:1px dashed #888; cursor:pointer; pointer-events:all; box-sizing:border-box; outline:none;",f=document.createElement("div"),f.className="magic-line-bar",f.style.cssText=`position:absolute; right:0; left:0; height:4px; background:${r().color}; border-radius:2px; box-shadow:0 1px 6px rgba(229,57,53,0.18); transition:background 0.15s; pointer-events: none;`,u.appendChild(f),p=document.createElement("span"),p.className="magic-line-pointer",p.style.cssText="display:block; width:14px; height:8px; position:absolute; left:0; pointer-events:none; user-select:none;",p.innerHTML=w("before",r().pointerColor),u.appendChild(p),g=document.createElement("span"),g.className="magic-line-tooltip",g.style.cssText="display:none; position:absolute; left:24px; background:rgba(32,32,32,0.97); color:white; font-size:12px; padding:2px 10px; border-radius:6px; pointer-events:none; white-space:normal; word-break:break-word; overflow-wrap:break-word;",g.textContent="",u.appendChild(g),h=document.createElement("div"),h.className="magic-line-hit-area",h.style.cssText="position: absolute; top: 0; left: 0; right: 0; height: 32px; z-index: 1; background: transparent; display: none; pointer-events: all; cursor: pointer;",s.appendChild(h),s.appendChild(u),i.push(u),["touchstart","touchend","mousedown","mouseup","pointerdown","pointerup","click"].forEach(t=>{h.addEventListener(t,n=>{e("[SML] [HIT] HIT AREA EVENT:",t,n)}),u.addEventListener(t,n=>{e("[SML] [HIT] MAGICLINE EVENT:",t,n)})});let n=!1;function o(t){t&&(t.preventDefault(),t.stopPropagation());let i=null,o=null;if(t.touches&&t.touches.length?(i=t.touches[0].clientX,o=t.touches[0].clientY):t.changedTouches&&t.changedTouches.length?(i=t.changedTouches[0].clientX,o=t.changedTouches[0].clientY):"number"==typeof t.clientX&&"number"==typeof t.clientY&&(i=t.clientX,o=t.clientY),null!==i&&null!==o){const n=document.elementFromPoint(i,o);e("[TOUCH/PTR] elementFromPoint:",n,"class:",n&&n.className,"tag:",n&&n.tagName,"XY:",i,o,"event type:",t.type)}if(("pointerdown"===t.type||"mousedown"===t.type)&&G)return void e("[ACT] Ignoring pointer/mouse event because of recent touch");"touchstart"===t.type&&(G=!0,setTimeout(()=>{G=!1},350));const l=t&&("touchstart"===t.type||t.pointerType&&"touch"===t.pointerType),a=u._blockRef;if(l){if(R=a,n=!0,_=!0,"block"!==u.style.display||R!==a||!_){let e=null;return t&&t.touches&&t.touches.length?e=t.touches[0].clientY:"number"==typeof t.clientY&&(e=t.clientY),void F(a,e,a.getBoundingClientRect())}n=!1,_=!1,R=null,"touchstart"===t.type?$(t):e("[ACT] Suppressed onMagicLineClick for event:",t.type)}else n=!1,_=!1,R=null,g.textContent="",$(t)}u.addEventListener("touchstart",o,{passive:!1}),u.addEventListener("pointerdown",o),h.addEventListener("touchstart",o,{passive:!1}),h.addEventListener("pointerdown",o);let l=null;h.addEventListener("mousemove",function(e){const t=u._blockRef,n=h.getBoundingClientRect(),i=e.clientY-n.top;let o=null;i<20?o="before":i>n.height-20&&(o="after"),o!==l&&(l=o,o&&B(t,o))}),h.addEventListener("mouseleave",()=>{l=null}),u.addEventListener("keydown",t=>{"Enter"===t.key||" "===t.key?$(t):"Escape"===t.key?D():"Tab"===t.key&&(!function(t,n){if(!i.length)return;let o=i.indexOf(t);-1===o&&(o=0);let l=n?(o+1)%i.length:(o-1+i.length)%i.length;i[l].focus(),e("[FCS] Focus cycled to index",l)}(u,!t.shiftKey),t.preventDefault())})}function $(n){let i=u._blockRef,o=u.dataset.position||"after";if(!i)return;let a=c.createElement("p");if(a.innerHTML='<br data-mce-bogus="1">',"before"===o?i.parentNode.insertBefore(a,i):"after"===o&&(i.nextSibling?i.parentNode.insertBefore(a,i.nextSibling):i.parentNode.appendChild(a)),l.selection.select(a,!0),l.selection.collapse(!0),t){e("[SET] SET data-magicline-",o,"on",i.outerHTML);const t=u._blockRef;if("before"===o?b=t.previousElementSibling||t:"after"===o&&(b=t.nextElementSibling||t),e("[SET] [1] block",t,"realBlock",b),u&&b&&u._blockRef){const e=u.dataset.position||"after";b.setAttribute("data-magicline-"+e,"used")}if(e("[SET] [2] block",i,"realBlock",b),!b)return void e("[SET] realBlock not found, skipping marker set for position",o);{let e=b.getAttribute("data-magicline-id")||!1;e||(e=String(Date.now())+Math.random().toString(36).slice(2),b.setAttribute("data-magicline-id",e)),x[e+"-"+o]=!0}}D(),n.preventDefault(),n.stopPropagation(),e("[ACT] MagicLine click: inserted paragraph",o,i)}function F(i,o,s,c,m){if(null==o&&console.warn("[ML DEBUG] mouseY is undefined/null in showMagicLineHybrid!"),v&&_)return g.textContent=`${G.tapAgain}`,u.setAttribute("aria-label",`${G.tapAgain}`),void(g.style.display="block");u._lastHighlight&&u._lastHighlight!==i&&(u._lastHighlight.classList.remove("magic-line-highlight"),u._lastHighlight=null),i.classList.contains("magic-line-highlight")||(i.classList.add("magic-line-highlight"),u._lastHighlight=i);const b=i.previousElementSibling,y=b?b.getBoundingClientRect():null,E=Array.from(d.querySelectorAll(n.join(","))),T=!y&&E.length&&E[0]===i;let L,x,C,k,M,N,A,S=!1,R=null;if("DIV"===i.nodeName){const e=i.querySelectorAll("img");if(i.classList.contains("serendipity_image_block")&&e.length>1)S=!0;else if(i.classList.contains("media_object_container"))S=!0;else if(1===e.length){R=function(e,t){let n=e;for(;n&&n!==t;){if("FIGURE"===n.tagName)return n.getBoundingClientRect();n=n.parentElement}return e.getBoundingClientRect()}(e[0],i);const t=Math.abs(R.top-Math.max(i.getBoundingClientRect().top));(R.width<500||"serendipity_image_left"===e[0].className||"serendipity_image_right"===e[0].className||t>9)&&i.classList.remove("magic-line-highlight")}}s=S?i.getBoundingClientRect():R||i.getBoundingClientRect(),m=l.iframeElement.getBoundingClientRect();const G=a();if(T&&y&&(A="P"===b.nodeName?16:Math.trunc(y.height)),L=s.left>15?s.left-15:s.left,x=s.top-1,C=m.width-s.width>30?s.width+30:s.width,k=s.height+2,T&&H(i)){M=("number"==typeof o?o-s.top:k/2)<s.height/2?"before":"after","after"===M&&(x=s.bottom-15,k=40)}e("[MLH] [ML DEBUG] Touch at",o,"Block rect:",s.top,s.bottom,"Decision:",o<s.top+s.height/2?"UP":"DOWN"),M=("number"==typeof o?o-s.top:k/2)<s.height/2?"before":"after";let P="before"===M?G.before:G.after;if(u.style.height=k+"px","before"===M)f&&(f.style.top="0px"),p&&(p.style.top="-4px"),g&&(g.style.top="8px");else{if(N=t?24:38,g){const e=g.style.display;g.style.display="block";const t=g.offsetHeight;g.style.display=e,g.style.top=s.height-t-N+"px"}f&&(f.style.top=s.height-4+"px"),p&&(p.style.top=s.height-7+"px"),R?(f&&(f.style.top=R.height-4+"px"),p&&(p.style.top=R.height-7+"px")):(f&&(f.style.top=s.height-4+"px"),p&&(p.style.top=s.height-7+"px"))}h&&(h.style.left=L+"px"),h&&A&&(x=A+x),h&&(h.style.width=C+"px"),u.style.left=L+"px",u.style.width=C+"px",T&&H(i)&&"after"===M?u.style.top=x+"px":u.style.top=(y?x-2:x)+"px",u.dataset.position=M,u._blockRef=i,p&&(p.innerHTML=w(M,r().pointerColor)),f&&(f.style.background=r().color);let $=i.nodeName,F=function(e){if(!e)return"";if("FIGURE"===e.nodeName){let t=e.querySelector("img");return t?t.alt||t.title||"[image]":"[figure]"}let t=e.textContent.replace(/\s+/g," ").trim();return t.length>20&&(t='"'+t.slice(0,18)+'..."'),t}(i);if(t&&!_&&(v=!0),v)return g.textContent=`${G.tapAgain}`,u.setAttribute("aria-label",`${G.tapAgain}`),void(g&&(e("[MLH] [GAP] [showTapAgainTip]",v,"position",M,"tooltipEl.offsetHeight",g.offsetHeight,"tooltipGap",N),N?20===g.offsetHeight&&(N=4):"after"===M&&20===g.offsetHeight&&(N=4),g.style.top=s.height-g.offsetHeight-N+"px"));if(_||(e("[MLH] where value:",P),u.setAttribute("aria-label",`${G.insertParagraph} ${P} <${$.toLowerCase()}>: ${F} ${G.hint}`),g&&"after"===M&&N&&(N=36===g.offsetHeight?4:40,e("[MLH] [GAP] [showTapAgainTip]",v,"position",M,"tooltipEl.offsetHeight",g.offsetHeight,"tooltipGap",N),g.style.top=s.height-g.offsetHeight-N+"px"),g.textContent=`${G.insertParagraph} ${P} <${$.toLowerCase()}>: ${F} ${G.hint}`),g.style.left="24px",e("[MLH] showMagicLineHybrid",M,$,L,x,C,k),"DIV"===i.nodeName){const t=i.querySelector("img");if(t&&e("[MLH] iframeRect:",m.top,m.bottom,m.width,m.height,"img.className",t.className),R&&R.width<500)if("serendipity_image_right"!==t.className){g.style.left="12px",g.style.paddingLeft="4px";const e=(Math.max(m.width)-R.width)/2;g.style.width=Math.max(m.width)-("serendipity_image_left"!==t.className?e:0)+"px"}else g.textContent=`${G.insertParagraph} ${P} <${$.toLowerCase()}>: ${F}[...]`}B(i,M)?I():D()}function z(t){if(!c||!d)return;if(_)return;R=null,_=!1;const{clientX:i,clientY:o}=t;if(void 0===o)return void console.warn("[ML DEBUG] clientY is undefined in onGlobalMagicLineMouseMove! Event:",t);let l=t.touches&&t.touches.length?t.touches[0].clientY:t.clientY;L=l;let a=c.elementFromPoint(i,o),r=(u&&(u===a||u.contains(a)),h&&(h===a||h.contains(a)),C(a,d));if(r){if(r&&((s=r)&&1===s.nodeType&&n.includes(s.nodeName))){if(y===r){clearTimeout(m);let e=o-r.getBoundingClientRect().top,t=r.getBoundingClientRect().height/2;return void(B(r,e<t?"before":"after")?I():D())}return y=r,F(r,o),e("[VIS] onGlobalMagicLineMouseMove: show on block",r),void clearTimeout(m)}var s;m=setTimeout(()=>{D(),y=null},180)}}function O(){m=setTimeout(()=>{y=null},180),e("[VIS] onGlobalMagicLineMouseLeave")}function Y(){d?(d.removeEventListener("mousemove",z),d.removeEventListener("mouseleave",O),d.addEventListener("mousemove",z),d.addEventListener("mouseleave",O),e("[GLB] addGlobalMagicLineListeners")):e("[GLB] addGlobalMagicLineListeners: iframeBody not ready")}function U(){let t=l.iframeElement.closest(".tox-edit-area");if(t&&u.parentNode!==t&&(t.appendChild(h),t.appendChild(u),s=t,e("[ACT] onResizeOrFullscreen: moved container")),u&&"block"===u.style.display&&u._blockRef){let t=L;if(null==t){const e=u._blockRef.getBoundingClientRect();t=e.top+e.height/2}F(u._blockRef,t),e("[ACT] onResizeOrFullscreen: repositioned")}}l.on("init",()=>{c=l.getDoc(),d=l.getBody(),k(d),s=l.iframeElement.closest(".tox-edit-area"),P(),Y(),window.addEventListener("resize",U),l.on("FullscreenStateChanged",U),l.on("NodeChange",U),l.on("SetContent",U),l.on("remove",()=>{u&&u.parentNode&&u.parentNode.removeChild(u),h&&h.parentNode&&h.parentNode.removeChild(h);let t=i.indexOf(u);t>-1&&i.splice(t,1),e("[ACT] editor remove")})}),l.on("SetContent",()=>{x={},l.getBody().querySelectorAll("[data-magicline-id]").forEach(e=>{const t=e.getAttribute("data-magicline-id");t&&(e.hasAttribute("data-magicline-before")&&(x[t+"-before"]=!0),e.hasAttribute("data-magicline-after")&&(x[t+"-after"]=!0))})}),l.on("NodeChange",()=>{Y()}),"undefined"!=typeof window&&window.addEventListener("styx:darkmode",()=>{let{color:t,pointerColor:n}=r();p&&(p.innerHTML=w(u.dataset.position||"before",n),f&&(f.style.background=t)),e("[GLB] styx:darkmode event")})})}();