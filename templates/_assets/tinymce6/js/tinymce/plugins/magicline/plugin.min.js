/**
 * TinyMCE MagicLine Plugin:
 * Adds a red "insert paragraph" line between block elements, with robust handling for images, galleries, floats, and touch devices.
 * Features smart overlays, accessibility, and device-specific hints.
 * Copyright Ian Styx for The Serendipity Styx blog Edition, last modified 2025-06-26, 18:12, v. 2.0.4
 */
!function(){function e(...e){const t=window.MAGICLINE_DEBUG_FILTER;if(!(window.MAGICLINE_DEBUG||!!t&&t.length>0))return;if(t){const n=e[0];if("string"!=typeof n||!n.startsWith(t))return}const n=new Error;let i="";if(n.stack){const e=n.stack.split("\n");if(e.length>=3){const t=e[2].trim();let n=t.match(/:(\d+:\d+)\)?$/);i=n?"[ "+n[1]+" ]":t}}console.log("[MagicLine]",...e,i)}const t="ontouchstart"in window,n=["DIV","FIGURE","H1","H2","SECTION","ARTICLE","ASIDE","NAV"],i=[],o={en:{insertParagraph:"Insert paragraph",touchTip:"Tap the red line to insert a new paragraph here!",tapAgain:"Tap again to insert a new paragraph here.",before:"before",after:"after",hint:' ... [ Hint: Some red line added elements are irreversible via the ↩ "undo" toolbar button! Particularly between picture containers. Use normal keyboard context delete or reset via source view. ]',tip:"Tip: Click or press Enter to insert a new paragraph here."},de:{insertParagraph:"Absatz einfügen",touchTip:"Tippen Sie auf die rote Linie, um hier einen neuen Absatz einzufügen!",tapAgain:"Tippen Sie erneut, um hier einen neuen Absatz einzufügen.",before:"vor",after:"nach",hint:' ... [ Hinweis: Manche Absätze über die rote Linie sind nicht über den ↩ "undo" Toolbar Button rückgängig zu machen! Inbesondere zwischen Bildcontainern. Löschen Sie diese über die Tastatur oder im Quellcode. ]',tip:"Tipp: Klicken oder Enter drücken, um hier einen neuen Absatz einzufügen."}};tinymce.PluginManager.add("magicline",function(l){function a(){const e=l&&l.settings&&l.settings.magicline_lang||l&&l.settings&&l.settings.language||"undefined"!=typeof navigator&&navigator.language||"en";return o[e.slice(0,2)]||o.en}function r(){const e=a(),t=l&&l.settings&&l.settings.magicline?l.settings.magicline:{};let n="undefined"!=typeof window&&"undefined"!=typeof STYX_DARKMODE&&!0===STYX_DARKMODE;return{color:t.color||"#e53935",pointerColor:n?"#cdd9e5":"#1e2127",linger:t.linger||2500,fadeDuration:t.fadeDuration||350,attentionPulse:t.attentionPulse||900,firstTimeTip:t.firstTimeTip||`${e.tip}${e.hint}`}}let s,c,d,u,p,g,f,h,m,b,y=null,E=null,L=null,T=null,v=!1,x={};function w(e,t){return"before"===e?`<svg width="14" height="8"><polygon points="7,0 0,8 14,8" style="fill:${t};"/></svg>`:`<svg width="14" height="8"><polygon points="7,8 0,0 14,0" style="fill:${t};"/></svg>`}function C(e,t){let n=e;for(;n&&n!==t;){if(n.parentElement===t)return n;n=n.parentElement}return null}function M(e){let n=!1,i=null;t&&(e.addEventListener("touchstart",e=>{n=!0}),e.addEventListener("touchend",e=>{n=!1,i=null,clearTimeout(L),L=setTimeout(D,4e3)}),e.addEventListener("touchmove",t=>{if(!n)return;const o=t.touches[0],l=C(document.elementFromPoint(o.clientX,o.clientY),e);l&&l!==i?(i=l,I(),function(e){if(localStorage.getItem("magicLineHintShown"))return;const t=a(),n=document.createElement("div");n.textContent=`${t.touchTip}`,n.className="magicline-tooltip",n.style.position="absolute",n.style.background="#333",n.style.color="#fff",n.style.padding="6px 12px",n.style.borderRadius="6px",n.style.fontSize="14px",n.style.zIndex=9998;const i=e.getBoundingClientRect();n.style.top=window.scrollY+i.top-36+"px",n.style.left=window.scrollX+i.left+24+"px",document.body.appendChild(n),setTimeout(()=>{n.remove()},2600),localStorage.setItem("magicLineHintShown","1")}(l)):l||(D(),i=null)}))}function k(e){return e&&"P"===e.nodeName}function N(e){return!!k(e)&&e.textContent.replace(/\u00A0/g,"").trim().length>0}function A(e){if(!e||"P"!==e.nodeName)return!1;let t=e.textContent.replace(/[\u00A0\s\u200B-\u200D\uFEFF]/g,""),n=e.innerHTML.replace(/<br.*?>/gi,"").replace(/&nbsp;/gi,"").replace(/[\s\u200B-\u200D\uFEFF]/g,"").trim();return""===t&&""===n}function S(e){return e&&1===e.nodeType&&("DIV"===e.nodeName||"FIGURE"===e.nodeName||"SECTION"===e.nodeName||"ARTICLE"===e.nodeName||"ASIDE"===e.nodeName||"NAV"===e.nodeName)}function H(e){return e&&/^H[1-6]$/.test(e.nodeName)}function B(n,i){if(!n)return!1;if(t){e("[GET] data-magicline-position:",i,"on",n.outerHTML),e("[GET] magicLineUsedMap",x);const t=u._blockRef;if("before"===i?b=t.previousElementSibling||t:"after"===i&&(b=t.nextElementSibling||t),e("[GET] block",t,"realBlock",b),b){e("[GET] realBlock",b);let t=b.getAttribute("data-magicline-id");if(t&&x[t+"-"+i]||b.hasAttribute("data-magicline-"+i))return e("[GET] BLOCK: gap already used by ID, suppress MagicLine",t,i),!1}if(!b)return G=!1,v=!1,!1;if(A(b))return!1;if((o=b)&&"DIV"===o.nodeName&&(e("[GET] [isHitArea] node-el",o),"magic-line-hit-area"===o.className&&"none"!==o.style.display))return G=!1,v=!1,!1}var o;if(e("[GET] CHECK data-magicline-position:",i,"on",n.outerHTML),e("[GET] shouldShowMagicLine for block:",n,"position:",i,"data-before:",n.getAttribute("data-magicline-before"),"data-after:",n.getAttribute("data-magicline-after")),"used"===n.getAttribute("data-magicline-"+i))return e("[GET] BLOCK: gap already used, suppress MagicLine",n,i),!1;const l=n.previousElementSibling,a=n.nextElementSibling;if(e("[GET] [SML] shouldShowMagicLine:",{block:n,position:i,prev:l?{nodeName:l.nodeName,html:l.innerHTML,text:l.textContent}:null,next:a?{nodeName:a.nodeName,html:a.innerHTML,text:a.textContent}:null}),n.parentNode){const t=Array.from(n.parentNode.children),o=t.indexOf(n);if("before"===i&&o>0){const n=t[o-1];if("P"===n.nodeName&&A(n))return e("[GET] BLOCK: found empty <p> before block, suppress MagicLine",n),!1}if("after"===i&&o<t.length-1){const n=t[o+1];if("P"===n.nodeName&&A(n))return e("[GET] BLOCK: found empty <p> after block, suppress MagicLine",n),!1}}if(e("[GET] shouldShowMagicLine: checking",n,"position:",i,"prev:",l,"next:",a),"before"===i&&l&&k(l)&&A(l))return e("[GET] BLOCK: found empty <p> before block, suppress MagicLine"),!1;if("after"===i&&a&&k(a)&&A(a))return e("[GET] BLOCK: found empty <p> after block, suppress MagicLine"),!1;if(t){if("before"===i&&l&&A(l))return!1;if("after"===i&&a&&A(a))return!1}if("before"===i&&l&&A(l))return e("[POS] shouldShowMagicLine: prevent before, empty <p> exists"),!1;if("after"===i&&a&&A(a))return e("[POS] shouldShowMagicLine: prevent after, empty <p> exists"),!1;if("before"===i&&!l)return!k(n);if("before"===i&&l&&"PRE"===l.nodeName||"after"===i&&a&&"PRE"===a.nodeName)return!0;if(S(n)&&"before"===i){if(k(l))return N(l);if(S(l)||H(l))return!0}if(S(n)&&"after"===i){if(k(a))return N(a);if(S(a)||H(a)||!a)return!0}return S(n)&&(S(l)||H(l))&&"before"===i?(!l||l.nextElementSibling!==n||!A(l))&&(D(),!0):(k(n),!1)}let R=null,G=!1,_=!1;function I(){clearTimeout(m),clearTimeout(E),clearTimeout(L),u.style.opacity=1,u.style.display="block",e("[SML] Tooltip text:",g.textContent,g.style.display),g.style.display="block",h&&(h.style.display="block",h.style.pointerEvents="all"),e("[SML] Show MagicLine",u._blockRef),E=setTimeout(()=>{u.style.opacity=0,L=setTimeout(()=>{if(u.style.display="none",g.style.display="none",h&&(h.style.display="none"),h&&(h.style.pointerEvents="none"),u._lastHighlight){let e=u._lastHighlight;e.classList.add("magic-line-fading"),setTimeout(()=>{e.classList.remove("magic-line-highlight","magic-line-fading")},300),u._lastHighlight=null}G=!1,R=null},r().fadeDuration)},r().linger)}function D(){clearTimeout(E),clearTimeout(L),u.style.opacity=0,g.style.display="none",G=!1,R=null,v=!1,h&&(h.style.display="none"),h&&(h.style.pointerEvents="none"),setTimeout(()=>{if(u.style.display="none",g.style.display="none",h&&(h.style.display="none"),h&&(h.style.pointerEvents="none"),u._lastHighlight){let e=u._lastHighlight;e.classList.add("magic-line-fading"),setTimeout(()=>{e.classList.remove("magic-line-highlight","magic-line-fading")},300),u._lastHighlight=null}G=!1,R=null,v=!1},r().fadeDuration)}function P(){const t=a();u=document.createElement("div"),u.className="magic-line",u.setAttribute("tabindex","0"),u.setAttribute("role","button"),u.setAttribute("aria-label",`Insert paragraph${t.hint}`),u.style.cssText="\n        position:absolute; top:0; left:0;\n        height:60px;\n        background:transparent;\n        z-index:9998;\n        display:none;\n        opacity:0;\n        transition:opacity 0.35s cubic-bezier(0.4,0,0.2,1), box-shadow 0.2s;\n        border:1px dashed #888;\n        cursor:pointer;\n        pointer-events:all;\n        box-sizing:border-box;\n        outline:none;\n      ",f=document.createElement("div"),f.className="magic-line-bar",f.style.cssText=`\n        position:absolute; right:0; left:0;\n        height:4px;\n        background:${r().color};\n        border-radius:2px;\n        box-shadow:0 1px 6px rgba(229,57,53,0.18);\n        transition:background 0.15s;\n        pointer-events: none;\n      `,u.appendChild(f),p=document.createElement("span"),p.className="magic-line-pointer",p.style.cssText="\n        display:block;\n        width:14px; height:8px;\n        position:absolute; left:0;\n        pointer-events:none;\n        user-select:none;\n      ",p.innerHTML=w("before",r().pointerColor),u.appendChild(p),g=document.createElement("span"),g.className="magic-line-tooltip",g.style.cssText="\n        display:none;\n        position:absolute; left:24px;\n        background:rgba(32,32,32,0.97);\n        color:white;\n        font-size:12px;\n        padding:2px 10px;\n        border-radius:6px;\n        pointer-events:none;\n        white-space:normal;\n        word-break:break-word;\n        overflow-wrap:break-word;\n        z-index:10000;\n      ",g.textContent="",u.appendChild(g),h=document.createElement("div"),h.className="magic-line-hit-area",h.style.cssText="\n        position: absolute; top: 0; left: 0; right: 0;\n        height: 32px;\n        z-index: 9999;\n        background: transparent;\n        display: none;\n        pointer-events: all;\n        cursor: pointer;\n      ",s.appendChild(h),s.appendChild(u),i.push(u),["touchstart","touchend","mousedown","mouseup","pointerdown","pointerup","click"].forEach(t=>{h.addEventListener(t,n=>{e("[SML] [HIT] HIT AREA EVENT:",t,n)}),u.addEventListener(t,n=>{e("[SML] [HIT] MAGICLINE EVENT:",t,n)})});let n=!1;function o(t){t&&(t.preventDefault(),t.stopPropagation());let i=null,o=null;if(t.touches&&t.touches.length?(i=t.touches[0].clientX,o=t.touches[0].clientY):t.changedTouches&&t.changedTouches.length?(i=t.changedTouches[0].clientX,o=t.changedTouches[0].clientY):"number"==typeof t.clientX&&"number"==typeof t.clientY&&(i=t.clientX,o=t.clientY),null!==i&&null!==o){const n=document.elementFromPoint(i,o);e("[TOUCH/PTR] elementFromPoint:",n,"class:",n&&n.className,"tag:",n&&n.tagName,"XY:",i,o,"event type:",t.type)}if(("pointerdown"===t.type||"mousedown"===t.type)&&_)return void e("[ACT] Ignoring pointer/mouse event because of recent touch");"touchstart"===t.type&&(_=!0,setTimeout(()=>{_=!1},350));const l=t&&("touchstart"===t.type||t.pointerType&&"touch"===t.pointerType),a=u._blockRef;if(l){if(R=a,n=!0,G=!0,"block"!==u.style.display||R!==a||!G){let e=null;return t&&t.touches&&t.touches.length?e=t.touches[0].clientY:"number"==typeof t.clientY&&(e=t.clientY),void z(a,e,a.getBoundingClientRect())}n=!1,G=!1,R=null,"touchstart"===t.type?$(t):e("[ACT] Suppressed onMagicLineClick for event:",t.type)}else n=!1,G=!1,R=null,g.textContent="",$(t)}u.addEventListener("touchstart",o,{passive:!1}),u.addEventListener("pointerdown",o),h.addEventListener("touchstart",o,{passive:!1}),h.addEventListener("pointerdown",o);let l=null;h.addEventListener("mousemove",function(e){const t=u._blockRef,n=h.getBoundingClientRect(),i=e.clientY-n.top;let o=null;i<20?o="before":i>n.height-20&&(o="after"),o!==l&&(l=o,o&&B(t,o))}),h.addEventListener("mouseleave",()=>{l=null}),u.addEventListener("focus",()=>{u.style.boxShadow="0 0 0 3px #3399ff",e("[ACT] focus MagicLine")}),u.addEventListener("blur",()=>{u.style.boxShadow="",e("[ACT] blur MagicLine")}),u.addEventListener("keydown",t=>{"Enter"===t.key||" "===t.key?$(t):"Escape"===t.key?(u.blur(),D()):"Tab"===t.key&&(!function(t,n){if(!i.length)return;let o=i.indexOf(t);-1===o&&(o=0);let l=n?(o+1)%i.length:(o-1+i.length)%i.length;i[l].focus(),e("[FCS] Focus cycled to index",l)}(u,!t.shiftKey),t.preventDefault())})}function $(n){let i=u._blockRef,o=u.dataset.position||"after";if(!i)return;let a=c.createElement("p");if(a.innerHTML='<br data-mce-bogus="1">',"before"===o?i.parentNode.insertBefore(a,i):"after"===o&&(i.nextSibling?i.parentNode.insertBefore(a,i.nextSibling):i.parentNode.appendChild(a)),l.selection.select(a,!0),l.selection.collapse(!0),t){e("[SET] SET data-magicline-",o,"on",i.outerHTML);const t=u._blockRef;if("before"===o?b=t.previousElementSibling||t:"after"===o&&(b=t.nextElementSibling||t),e("[SET] [1] block",t,"realBlock",b),u&&b&&u._blockRef){const e=u.dataset.position||"after";b.setAttribute("data-magicline-"+e,"used")}if(e("[SET] [2] block",i,"realBlock",b),!b)return void e("[SET] realBlock not found, skipping marker set for position",o);{let e=b.getAttribute("data-magicline-id")||!1;e||(e=String(Date.now())+Math.random().toString(36).slice(2),b.setAttribute("data-magicline-id",e)),x[e+"-"+o]=!0}}D(),document.activeElement===u&&u.blur(),h&&document.activeElement===h&&h.blur(),n.preventDefault(),n.stopPropagation(),e("[ACT] MagicLine click: inserted paragraph",o,i)}function z(i,o,s,c,m){if(null==o&&console.warn("[ML DEBUG] mouseY is undefined/null in showMagicLineHybrid!"),v&&G)return g.textContent=`${S.tapAgain}`,u.setAttribute("aria-label",`${S.tapAgain}`),void(g.style.display="block");u._lastHighlight&&u._lastHighlight!==i&&(u._lastHighlight.classList.remove("magic-line-highlight"),u._lastHighlight=null),i.classList.contains("magic-line-highlight")||(i.classList.add("magic-line-highlight"),u._lastHighlight=i);const b=Array.from(d.querySelectorAll(n.join(","))),y=b.length&&b[0]===i;let E,L,T,x,C,M,k,N=!1,A=null;if("DIV"===i.nodeName){const e=i.querySelectorAll("img");if(i.classList.contains("serendipity_image_block")&&e.length>1)N=!0;else if(1===e.length){A=function(e,t){let n=e;for(;n&&n!==t;){if("FIGURE"===n.tagName)return n.getBoundingClientRect();n=n.parentElement}return e.getBoundingClientRect()}(e[0],i);const t=Math.abs(A.top-Math.max(i.getBoundingClientRect().top));(A.width<500||"serendipity_image_left"===e[0].className||"serendipity_image_right"===e[0].className||t>9)&&i.classList.remove("magic-line-highlight")}}s=N?i.getBoundingClientRect():A||i.getBoundingClientRect(),m=l.iframeElement.getBoundingClientRect();const S=a(),R=i.previousElementSibling,_=R?R.getBoundingClientRect():null;if(y&&_&&(k="P"===R.nodeName?16:Math.trunc(_.height)),E=s.left-15,L=y?Math.max(0,s.top-20):s.top,T=s.width+30,x=s.height+8,y&&H(i)){C=("number"==typeof o?o-s.top:x/2)<s.height/2?"before":"after","after"===C&&(L=s.bottom-15,x=40)}e("[MLH] [ML DEBUG] Touch at",o,"Block rect:",s.top,s.bottom,"Decision:",o<s.top+s.height/2?"UP":"DOWN"),C=("number"==typeof o?o-s.top:x/2)<s.height/2?"before":"after";let P="before"===C?S.before:S.after;if(u.style.height=x+"px","before"===C)f&&(f.style.top="0px"),p&&(p.style.top="-4px"),g&&(g.style.top="8px");else{if(M=t?24:38,g){const e=g.style.display;g.style.display="block";const t=g.offsetHeight;g.style.display=e,g.style.top=s.height-t-M+"px"}f&&(f.style.top=s.height-4+"px"),p&&(p.style.top=s.height-7+"px"),A?(f&&(f.style.top=A.height-4+"px"),p&&(p.style.top=A.height-7+"px")):(f&&(f.style.top=s.height-4+"px"),p&&(p.style.top=s.height-7+"px"))}h&&(h.style.left=E+"px"),h&&k&&(L=k+L),h&&(h.style.width=T+"px"),u.style.left=E+"px",u.style.width=T+"px",y&&H(i)&&"after"===C?u.style.top=L+"px":u.style.top=(_?L-2:L)+"px",u.dataset.position=C,u._blockRef=i,p&&(p.innerHTML=w(C,r().pointerColor)),f&&(f.style.background=r().color);let $=i.nodeName,z=function(e){if(!e)return"";if("FIGURE"===e.nodeName){let t=e.querySelector("img");return t?t.alt||t.title||"[image]":"[figure]"}let t=e.textContent.replace(/\s+/g," ").trim();return t.length>20&&(t='"'+t.slice(0,18)+'..."'),t}(i);if(t&&!G&&(v=!0),v)return g.textContent=`${S.tapAgain}`,u.setAttribute("aria-label",`${S.tapAgain}`),void(g&&(e("[MLH] [GAP] [showTapAgainTip]",v,"position",C,"tooltipEl.offsetHeight",g.offsetHeight,"tooltipGap",M),M?20===g.offsetHeight&&(M=4):"after"===C&&20===g.offsetHeight&&(M=4),g.style.top=s.height-g.offsetHeight-M+"px"));if(G||(e("[MLH] where value:",P),u.setAttribute("aria-label",`${S.insertParagraph} ${P} <${$.toLowerCase()}>: ${z} ${S.hint}`),g&&"after"===C&&M&&(M=36===g.offsetHeight?4:40,e("[MLH] [GAP] [showTapAgainTip]",v,"position",C,"tooltipEl.offsetHeight",g.offsetHeight,"tooltipGap",M),g.style.top=s.height-g.offsetHeight-M+"px"),g.textContent=`${S.insertParagraph} ${P} <${$.toLowerCase()}>: ${z} ${S.hint}`),g.style.left="24px",e("[MLH] showMagicLineHybrid",C,$,E,L,T,x),"DIV"===i.nodeName){const t=i.querySelector("img");if(t&&e("[MLH] iframeRect:",m.top,m.bottom,m.width,m.height,"img.className",t.className),A&&A.width<500)if("serendipity_image_right"!==t.className){g.style.left="12px",g.style.paddingLeft="4px";const e=(Math.max(m.width)-A.width)/2;g.style.width=Math.max(m.width)-("serendipity_image_left"!==t.className?e:0)+"px"}else g.textContent=`${S.insertParagraph} ${P} <${$.toLowerCase()}>: ${z}[...]`}B(i,C)?I():D()}function F(t){if(!c||!d)return;if(G)return;R=null,G=!1;const{clientX:i,clientY:o}=t;if(void 0===o)return void console.warn("[ML DEBUG] clientY is undefined in onGlobalMagicLineMouseMove! Event:",t);let l=t.touches&&t.touches.length?t.touches[0].clientY:t.clientY;T=l;let a=c.elementFromPoint(i,o),r=(u&&(u===a||u.contains(a)),h&&(h===a||h.contains(a)),C(a,d));if(r){if(r&&((s=r)&&1===s.nodeType&&n.includes(s.nodeName))){if(y===r){clearTimeout(m);let e=o-r.getBoundingClientRect().top,t=r.getBoundingClientRect().height/2;return void(B(r,e<t?"before":"after")?I():D())}return y=r,z(r,o),e("[VIS] onGlobalMagicLineMouseMove: show on block",r),void clearTimeout(m)}var s;m=setTimeout(()=>{D(),y=null},180)}}function O(){m=setTimeout(()=>{y=null},180),e("[VIS] onGlobalMagicLineMouseLeave")}function Y(){d?(d.removeEventListener("mousemove",F),d.removeEventListener("mouseleave",O),d.addEventListener("mousemove",F),d.addEventListener("mouseleave",O),e("[GLB] addGlobalMagicLineListeners")):e("[GLB] addGlobalMagicLineListeners: iframeBody not ready")}function U(){let t=l.iframeElement.closest(".tox-edit-area");if(t&&u.parentNode!==t&&(t.appendChild(h),t.appendChild(u),s=t,e("[ACT] onResizeOrFullscreen: moved container")),u&&"block"===u.style.display&&u._blockRef){let t=T;if(null==t){const e=u._blockRef.getBoundingClientRect();t=e.top+e.height/2}z(u._blockRef,t),e("[ACT] onResizeOrFullscreen: repositioned")}}l.on("init",()=>{c=l.getDoc(),d=l.getBody(),M(d),s=l.iframeElement.closest(".tox-edit-area"),P(),Y(),window.addEventListener("resize",U),l.on("FullscreenStateChanged",U),l.on("NodeChange",U),l.on("SetContent",U),l.on("remove",()=>{u&&u.parentNode&&u.parentNode.removeChild(u),h&&h.parentNode&&h.parentNode.removeChild(h);let t=i.indexOf(u);t>-1&&i.splice(t,1),e("[ACT] editor remove")})}),l.on("SetContent",()=>{x={},l.getBody().querySelectorAll("[data-magicline-id]").forEach(e=>{const t=e.getAttribute("data-magicline-id");t&&(e.hasAttribute("data-magicline-before")&&(x[t+"-before"]=!0),e.hasAttribute("data-magicline-after")&&(x[t+"-after"]=!0))})}),l.on("NodeChange",()=>{Y()}),"undefined"!=typeof window&&window.addEventListener("styx:darkmode",()=>{let{color:t,pointerColor:n}=r();p&&(p.innerHTML=w(u.dataset.position||"before",n),f&&(f.style.background=t)),e("[GLB] styx:darkmode event")})})}();